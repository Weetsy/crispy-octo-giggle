"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
Object.defineProperty(exports, "StartOptions", {
  enumerable: true,
  get: function () {
    return _sharedTypes.StartOptions;
  }
});
exports.default = void 0;

require("source-map-support/register");

require("colors");

var _asyncOra = require("@electron-forge/async-ora");

var _debug = _interopRequireDefault(require("debug"));

var _sharedTypes = require("@electron-forge/shared-types");

var _child_process = require("child_process");

var _electronVersion = require("../util/electron-version");

var _forgeConfig = _interopRequireDefault(require("../util/forge-config"));

var _electronExecutable = _interopRequireDefault(require("../util/electron-executable"));

var _readPackageJson = require("../util/read-package-json");

var _rebuild = _interopRequireDefault(require("../util/rebuild"));

var _resolveDir = _interopRequireDefault(require("../util/resolve-dir"));

var _hook = require("../util/hook");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const d = (0, _debug.default)('electron-forge:start');

var _default = async ({
  dir = process.cwd(),
  appPath = '.',
  interactive = false,
  enableLogging = false,
  args = [],
  runAsNode = false,
  inspect = false
}) => {
  _asyncOra.asyncOra.interactive = interactive;
  await (0, _asyncOra.asyncOra)('Locating Application', async () => {
    const resolvedDir = await (0, _resolveDir.default)(dir);

    if (!resolvedDir) {
      throw new Error('Failed to locate startable Electron application');
    }

    dir = resolvedDir;
  });
  const forgeConfig = await (0, _forgeConfig.default)(dir);
  const packageJSON = await (0, _readPackageJson.readMutatedPackageJson)(dir, forgeConfig);

  if (!packageJSON.version) {
    throw new Error(`Please set your application's 'version' in '${dir}/package.json'.`);
  }

  await (0, _rebuild.default)(dir, await (0, _electronVersion.getElectronVersion)(dir, packageJSON), process.platform, process.arch, forgeConfig.electronRebuildConfig);
  await (0, _hook.runHook)(forgeConfig, 'generateAssets');
  let lastSpawned = null;

  const forgeSpawn = async () => {
    let electronExecPath = null; // If a plugin has taken over the start command let's stop here

    const spawnedPluginChild = await forgeConfig.pluginInterface.overrideStartLogic({
      dir,
      appPath,
      interactive,
      enableLogging,
      args,
      runAsNode,
      inspect
    });
    let prefixArgs = [];

    if (typeof spawnedPluginChild === 'string') {
      electronExecPath = spawnedPluginChild;
    } else if (Array.isArray(spawnedPluginChild)) {
      [electronExecPath, ...prefixArgs] = spawnedPluginChild;
    } else if (spawnedPluginChild) {
      await (0, _hook.runHook)(forgeConfig, 'postStart', spawnedPluginChild);
      return spawnedPluginChild;
    }

    if (!electronExecPath) {
      electronExecPath = await (0, _electronExecutable.default)(dir, packageJSON);
    }

    d('Electron binary path:', electronExecPath);
    const spawnOpts = {
      cwd: dir,
      stdio: 'inherit',
      env: { ...process.env,
        ...(enableLogging ? {
          ELECTRON_ENABLE_LOGGING: 'true',
          ELECTRON_ENABLE_STACK_DUMPING: 'true'
        } : {})
      }
    };

    if (runAsNode) {
      spawnOpts.env.ELECTRON_RUN_AS_NODE = 'true';
    } else {
      delete spawnOpts.env.ELECTRON_RUN_AS_NODE;
    }

    if (inspect) {
      args = ['--inspect'].concat(args);
    }

    let spawned;
    await (0, _asyncOra.asyncOra)('Launching Application', async () => {
      spawned = (0, _child_process.spawn)(electronExecPath, prefixArgs.concat([appPath]).concat(args), spawnOpts);
    });
    await (0, _hook.runHook)(forgeConfig, 'postStart', spawned);
    return spawned;
  };

  const forgeSpawnWrapper = async () => {
    const spawned = await forgeSpawn(); // When the child app is closed we should stop listening for stdin

    if (spawned) {
      if (interactive && process.stdin.isPaused()) {
        process.stdin.resume();
      }

      spawned.on('exit', () => {
        if (spawned.restarted) return;
        if (!process.stdin.isPaused()) process.stdin.pause();
      });
    } else if (interactive && !process.stdin.isPaused()) {
      process.stdin.pause();
    }

    lastSpawned = spawned;
    return lastSpawned;
  };

  if (interactive) {
    process.stdin.on('data', async data => {
      if (data.toString().trim() === 'rs' && lastSpawned) {
        // eslint-disable-next-line no-console
        console.info('\nRestarting App\n'.cyan);
        lastSpawned.restarted = true;
        lastSpawned.kill('SIGTERM');
        lastSpawned.emit('restarted', await forgeSpawnWrapper());
      }
    });
  }

  return forgeSpawnWrapper();
};

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvc3RhcnQudHMiXSwibmFtZXMiOlsiZCIsImRpciIsInByb2Nlc3MiLCJjd2QiLCJhcHBQYXRoIiwiaW50ZXJhY3RpdmUiLCJlbmFibGVMb2dnaW5nIiwiYXJncyIsInJ1bkFzTm9kZSIsImluc3BlY3QiLCJhc3luY09yYSIsInJlc29sdmVkRGlyIiwiRXJyb3IiLCJmb3JnZUNvbmZpZyIsInBhY2thZ2VKU09OIiwidmVyc2lvbiIsInBsYXRmb3JtIiwiYXJjaCIsImVsZWN0cm9uUmVidWlsZENvbmZpZyIsImxhc3RTcGF3bmVkIiwiZm9yZ2VTcGF3biIsImVsZWN0cm9uRXhlY1BhdGgiLCJzcGF3bmVkUGx1Z2luQ2hpbGQiLCJwbHVnaW5JbnRlcmZhY2UiLCJvdmVycmlkZVN0YXJ0TG9naWMiLCJwcmVmaXhBcmdzIiwiQXJyYXkiLCJpc0FycmF5Iiwic3Bhd25PcHRzIiwic3RkaW8iLCJlbnYiLCJFTEVDVFJPTl9FTkFCTEVfTE9HR0lORyIsIkVMRUNUUk9OX0VOQUJMRV9TVEFDS19EVU1QSU5HIiwiRUxFQ1RST05fUlVOX0FTX05PREUiLCJjb25jYXQiLCJzcGF3bmVkIiwiZm9yZ2VTcGF3bldyYXBwZXIiLCJzdGRpbiIsImlzUGF1c2VkIiwicmVzdW1lIiwib24iLCJyZXN0YXJ0ZWQiLCJwYXVzZSIsImRhdGEiLCJ0b1N0cmluZyIsInRyaW0iLCJjb25zb2xlIiwiaW5mbyIsImN5YW4iLCJraWxsIiwiZW1pdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxDQUFDLEdBQUcsb0JBQU0sc0JBQU4sQ0FBVjs7ZUFJZSxPQUFPO0FBQ3BCQyxFQUFBQSxHQUFHLEdBQUdDLE9BQU8sQ0FBQ0MsR0FBUixFQURjO0FBRXBCQyxFQUFBQSxPQUFPLEdBQUcsR0FGVTtBQUdwQkMsRUFB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Q0FBQ0gsT0FBTyxDQUFDbUMsS0FBUixDQUFjQyxRQUFkLEVBQXBCLEVBQThDO0FBQ25EcEMsTUFBQUEsT0FBTyxDQUFDbUMsS0FBUixDQUFjSyxLQUFkO0FBQ0Q7O0FBRUR2QixJQUFBQSxXQUFXLEdBQUdnQixPQUFkO0FBQ0EsV0FBT2hCLFdBQVA7QUFDRCxHQWxCRDs7QUFvQkEsTUFBSWQsV0FBSixFQUFpQjtBQUNmSCxJQUFBQSxPQUFPLENBQUNtQyxLQUFSLENBQWNHLEVBQWQsQ0FBaUIsTUFBakIsRUFBeUIsTUFBT0csSUFBUCxJQUFnQjtBQUN2QyxVQUFJQSxJQUFJLENBQUNDLFFBQUwsR0FBZ0JDLElBQWhCLE9BQTJCLElBQTNCLElBQW1DMUIsV0FBdkMsRUFBb0Q7QUFDbEQ7QUFDQTJCLFFBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUFhLHFCQUFxQkMsSUFBbEM7QUFDQTdCLFFBQUFBLFdBQVcsQ0FBQ3NCLFNBQVosR0FBd0IsSUFBeEI7QUFDQXRCLFFBQUFBLFdBQVcsQ0FBQzhCLElBQVosQ0FBaUIsU0FBakI7QUFDQTlCLFFBQUFBLFdBQVcsQ0FBQytCLElBQVosQ0FBaUIsV0FBakIsRUFBOEIsTUFBTWQsaUJBQWlCLEVBQXJEO0FBQ0Q7QUFDRixLQVJEO0FBU0Q7O0FBRUQsU0FBT0EsaUJBQWlCLEVBQXhCO0FBQ0QsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29sb3JzJztcbmltcG9ydCB7IGFzeW5jT3JhIH0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL2FzeW5jLW9yYSc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHtcbiAgRWxlY3Ryb25Qcm9jZXNzLCBGb3JnZUFyY2gsIEZvcmdlUGxhdGZvcm0sIFN0YXJ0T3B0aW9ucyxcbn0gZnJvbSAnQGVsZWN0cm9uLWZvcmdlL3NoYXJlZC10eXBlcyc7XG5pbXBvcnQgeyBzcGF3biwgU3Bhd25PcHRpb25zIH0gZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5cbmltcG9ydCB7IGdldEVsZWN0cm9uVmVyc2lvbiB9IGZyb20gJy4uL3V0aWwvZWxlY3Ryb24tdmVyc2lvbic7XG5pbXBvcnQgZ2V0Rm9yZ2VDb25maWcgZnJvbSAnLi4vdXRpbC9mb3JnZS1jb25maWcnO1xuaW1wb3J0IGxvY2F0ZUVsZWN0cm9uRXhlY3V0YWJsZSBmcm9tICcuLi91dGlsL2VsZWN0cm9uLWV4ZWN1dGFibGUnO1xuaW1wb3J0IHsgcmVhZE11dGF0ZWRQYWNrYWdlSnNvbiB9IGZyb20gJy4uL3V0aWwvcmVhZC1wYWNrYWdlLWpzb24nO1xuaW1wb3J0IHJlYnVpbGQgZnJvbSAnLi4vdXRpbC9yZWJ1aWxkJztcbmltcG9ydCByZXNvbHZlRGlyIGZyb20gJy4uL3V0aWwvcmVzb2x2ZS1kaXInO1xuaW1wb3J0IHsgcnVuSG9vayB9IGZyb20gJy4uL3V0aWwvaG9vayc7XG5cbmNvbnN0IGQgPSBkZWJ1ZygnZWxlY3Ryb24tZm9yZ2U6c3RhcnQnKTtcblxuZXhwb3J0IHsgU3RhcnRPcHRpb25zIH07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jICh7XG4gIGRpciA9IHByb2Nlc3MuY3dkKCksXG4gIGFwcFBhdGggPSAnLicsXG4gIGludGVyYWN0aXZlID0gZmFsc2UsXG4gIGVuYWJsZUxvZ2dpbmcgPSBmYWxzZSxcbiAgYXJncyA9IFtdLFxuICBydW5Bc05vZGUgPSBmYWxzZSxcbiAgaW5zcGVjdCA9IGZhbHNlLFxufTogU3RhcnRPcHRpb25zKSA9PiB7XG4gIGFzeW5jT3JhLmludGVyYWN0aXZlID0gaW50ZXJhY3RpdmU7XG5cbiAgYXdhaXQgYXN5bmNPcmEoJ0xvY2F0aW5nIEFwcGxpY2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlc29sdmVkRGlyID0gYXdhaXQgcmVzb2x2ZURpcihkaXIpO1xuICAgIGlmICghcmVzb2x2ZWREaXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGxvY2F0ZSBzdGFydGFibGUgRWxlY3Ryb24gYXBwbGljYXRpb24nKTtcbiAgICB9XG4gICAgZGlyID0gcmVzb2x2ZWREaXI7XG4gIH0pO1xuXG4gIGNvbnN0IGZvcmdlQ29uZmlnID0gYXdhaXQgZ2V0Rm9yZ2VDb25maWcoZGlyKTtcbiAgY29uc3QgcGFja2FnZUpTT04gPSBhd2FpdCByZWFkTXV0YXRlZFBhY2thZ2VKc29uKGRpciwgZm9yZ2VDb25maWcpO1xuXG4gIGlmICghcGFja2FnZUpTT04udmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgUGxlYXNlIHNldCB5b3VyIGFwcGxpY2F0aW9uJ3MgJ3ZlcnNpb24nIGluICcke2Rpcn0vcGFja2FnZS5qc29uJy5gKTtcbiAgfVxuXG4gIGF3YWl0IHJlYnVpbGQoXG4gICAgZGlyLFxuICAgIGF3YWl0IGdldEVsZWN0cm9uVmVyc2lvbihkaXIsIHBhY2thZ2VKU09OKSxcbiAgICBwcm9jZXNzLnBsYXRmb3JtIGFzIEZvcmdlUGxhdGZvcm0sXG4gICAgcHJvY2Vzcy5hcmNoIGFzIEZvcmdlQXJjaCxcbiAgICBmb3JnZUNvbmZpZy5lbGVjdHJvblJlYnVpbGRDb25maWcsXG4gICk7XG5cbiAgYXdhaXQgcnVuSG9vayhmb3JnZUNvbmZpZywgJ2dlbmVyYXRlQXNzZXRzJyk7XG5cbiAgbGV0IGxhc3RTcGF3bmVkOiBFbGVjdHJvblByb2Nlc3MgfCBudWxsID0gbnVsbDtcblxuICBjb25zdCBmb3JnZVNwYXduID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCBlbGVjdHJvbkV4ZWNQYXRoOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuICAgIC8vIElmIGEgcGx1Z2luIGhhcyB0YWtlbiBvdmVyIHRoZSBzdGFydCBjb21tYW5kIGxldCdzIHN0b3AgaGVyZVxuICAgIGNvbnN0IHNwYXduZWRQbHVnaW5DaGlsZCA9IGF3YWl0IGZvcmdlQ29uZmlnLnBsdWdpbkludGVyZmFjZS5vdmVycmlkZVN0YXJ0TG9naWMoe1xuICAgICAgZGlyLFxuICAgICAgYXBwUGF0aCxcbiAgICAgIGludGVyYWN0aXZlLFxuICAgICAgZW5hYmxlTG9nZ2luZyxcbiAgICAgIGFyZ3MsXG4gICAgICBydW5Bc05vZGUsXG4gICAgICBpbnNwZWN0LFxuICAgIH0pO1xuICAgIGxldCBwcmVmaXhBcmdzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGlmICh0eXBlb2Ygc3Bhd25lZFBsdWdpbkNoaWxkID09PSAnc3RyaW5nJykge1xuICAgICAgZWxlY3Ryb25FeGVjUGF0aCA9IHNwYXduZWRQbHVnaW5DaGlsZDtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoc3Bhd25lZFBsdWdpbkNoaWxkKSkge1xuICAgICAgW2VsZWN0cm9uRXhlY1BhdGgsIC4uLnByZWZpeEFyZ3NdID0gc3Bhd25lZFBsdWdpbkNoaWxkO1xuICAgIH0gZWxzZSBpZiAoc3Bhd25lZFBsdWdpbkNoaWxkKSB7XG4gICAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncG9zdFN0YXJ0Jywgc3Bhd25lZFBsdWdpbkNoaWxkKTtcbiAgICAgIHJldHVybiBzcGF3bmVkUGx1Z2luQ2hpbGQ7XG4gICAgfVxuXG4gICAgaWYgKCFlbGVjdHJvbkV4ZWNQYXRoKSB7XG4gICAgICBlbGVjdHJvbkV4ZWNQYXRoID0gYXdhaXQgbG9jYXRlRWxlY3Ryb25FeGVjdXRhYmxlKGRpciwgcGFja2FnZUpTT04pO1xuICAgIH1cblxuICAgIGQoJ0VsZWN0cm9uIGJpbmFyeSBwYXRoOicsIGVsZWN0cm9uRXhlY1BhdGgpO1xuXG4gICAgY29uc3Qgc3Bhd25PcHRzID0ge1xuICAgICAgY3dkOiBkaXIsXG4gICAgICBzdGRpbzogJ2luaGVyaXQnLFxuICAgICAgZW52OiAoe1xuICAgICAgICAuLi5wcm9jZXNzLmVudixcbiAgICAgICAgLi4uKGVuYWJsZUxvZ2dpbmcgPyB7XG4gICAgICAgICAgRUxFQ1RST05fRU5BQkxFX0xPR0dJTkc6ICd0cnVlJyxcbiAgICAgICAgICBFTEVDVFJPTl9FTkFCTEVfU1RBQ0tfRFVNUElORzogJ3RydWUnLFxuICAgICAgICB9IDoge30pLFxuICAgICAgfSkgYXMgTm9kZUpTLlByb2Nlc3NFbnYsXG4gICAgfTtcblxuICAgIGlmIChydW5Bc05vZGUpIHtcbiAgICAgIHNwYXduT3B0cy5lbnYuRUxFQ1RST05fUlVOX0FTX05PREUgPSAndHJ1ZSc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlbGV0ZSBzcGF3bk9wdHMuZW52LkVMRUNUUk9OX1JVTl9BU19OT0RFO1xuICAgIH1cblxuICAgIGlmIChpbnNwZWN0KSB7XG4gICAgICBhcmdzID0gWyctLWluc3BlY3QnIGFzIChzdHJpbmd8bnVtYmVyKV0uY29uY2F0KGFyZ3MpO1xuICAgIH1cblxuICAgIGxldCBzcGF3bmVkITogRWxlY3Ryb25Qcm9jZXNzO1xuXG4gICAgYXdhaXQgYXN5bmNPcmEoJ0xhdW5jaGluZyBBcHBsaWNhdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIHNwYXduZWQgPSBzcGF3bihcbiAgICAgICAgZWxlY3Ryb25FeGVjUGF0aCEsXG4gICAgICAgIHByZWZpeEFyZ3MuY29uY2F0KFthcHBQYXRoXSkuY29uY2F0KGFyZ3MgYXMgc3RyaW5nW10pLFxuICAgICAgICBzcGF3bk9wdHMgYXMgU3Bhd25PcHRpb25zLFxuICAgICAgKSBhcyBFbGVjdHJvblByb2Nlc3M7XG4gICAgfSk7XG5cbiAgICBhd2FpdCBydW5Ib29rKGZvcmdlQ29uZmlnLCAncG9zdFN0YXJ0Jywgc3Bhd25lZCk7XG4gICAgcmV0dXJuIHNwYXduZWQ7XG4gIH07XG5cbiAgY29uc3QgZm9yZ2VTcGF3bldyYXBwZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc3Bhd25lZCA9IGF3YWl0IGZvcmdlU3Bhd24oKTtcbiAgICAvLyBXaGVuIHRoZSBjaGlsZCBhcHAgaXMgY2xvc2VkIHdlIHNob3VsZCBzdG9wIGxpc3RlbmluZyBmb3Igc3RkaW5cbiAgICBpZiAoc3Bhd25lZCkge1xuICAgICAgaWYgKGludGVyYWN0aXZlICYmIHByb2Nlc3Muc3RkaW4uaXNQYXVzZWQoKSkge1xuICAgICAgICBwcm9jZXNzLnN0ZGluLnJlc3VtZSgpO1xuICAgICAgfVxuICAgICAgc3Bhd25lZC5vbignZXhpdCcsICgpID0+IHtcbiAgICAgICAgaWYgKHNwYXduZWQucmVzdGFydGVkKSByZXR1cm47XG5cbiAgICAgICAgaWYgKCFwcm9jZXNzLnN0ZGluLmlzUGF1c2VkKCkpIHByb2Nlc3Muc3RkaW4ucGF1c2UoKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAoaW50ZXJhY3RpdmUgJiYgIXByb2Nlc3Muc3RkaW4uaXNQYXVzZWQoKSkge1xuICAgICAgcHJvY2Vzcy5zdGRpbi5wYXVzZSgpO1xuICAgIH1cblxuICAgIGxhc3RTcGF3bmVkID0gc3Bhd25lZDtcbiAgICByZXR1cm4gbGFzdFNwYXduZWQ7XG4gIH07XG5cbiAgaWYgKGludGVyYWN0aXZlKSB7XG4gICAgcHJvY2Vzcy5zdGRpbi5vbignZGF0YScsIGFzeW5jIChkYXRhKSA9PiB7XG4gICAgICBpZiAoZGF0YS50b1N0cmluZygpLnRyaW0oKSA9PT0gJ3JzJyAmJiBsYXN0U3Bhd25lZCkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLmluZm8oJ1xcblJlc3RhcnRpbmcgQXBwXFxuJy5jeWFuKTtcbiAgICAgICAgbGFzdFNwYXduZWQucmVzdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgbGFzdFNwYXduZWQua2lsbCgnU0lHVEVSTScpO1xuICAgICAgICBsYXN0U3Bhd25lZC5lbWl0KCdyZXN0YXJ0ZWQnLCBhd2FpdCBmb3JnZVNwYXduV3JhcHBlcigpKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBmb3JnZVNwYXduV3JhcHBlcigpO1xufTtcbiJdfQ==